/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2023 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.SourceHTML={}))}(this,(function(e){"use strict";var t=function(e,t){return-1!==t.indexOf(e)},r=function(e){return Array.isArray(e)},n=function(e){return"function"==typeof e},o=function(e,t){return e&&s(t)&&e instanceof t},i=function(e,t){return void 0===t&&(t=!0),"object"==typeof e&&(!t||o(e,Object))},s=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},c=function(e){return"string"==typeof e},a=window.location,l=function(e,t){return function(e){return o(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,s(t)?t:"g"))},u=function(e){return e.length},p=function(e,t){return void 0===t&&(t=!0),e=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),t&&(e=e.replace(/&apos;/g,"'").replace(/&quot;/g,'"')),e},f=function(e,t){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),t&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},h=function e(){for(var n=arguments.length,o=Array(n),c=0;c<n;c++)o[c]=arguments[c];for(var a=o.shift(),l=0,p=u(o);l<p;++l)for(var f in o[l])if(s(a[f]))if(r(a[f])&&r(o[l][f])){a[f]=[].concat(a[f]);for(var h=0,d=u(o[l][f]);h<d;++h)t(o[l][f][h],a[f])||a[f].push(o[l][f][h])}else i(a[f])&&i(o[l][f])?a[f]=e({},a[f],o[l][f]):a[f]=o[l][f];else a[f]=o[l][f];return a},d=function e(t){if(r(t))return t.map((function(r){return e(t)}));if(i(t)){for(var n in t)t[n]=e(t[n]);return t}return!1===t?"false":null===t?"null":!0===t?"true":""+t},g={};function b(e){if(!e)return"";var t;e=(t=e,Object.keys(t)).sort().reduce((function(t,r){return t[r]=e[r],t}),{});var r,n,o="";for(r in e)!1!==(n=e[r])&&null!==n&&(o+=" "+r,!0!==n&&(o+='="'+f(d(n),!0)+'"'));return o}function m(e){return!1!==e&&(c(e)?e=[e,e]:r(e)||(e=["",""]),s(e[1])||(e[1]=e[0])),e}g.insert=function(e,t,r,n){void 0===t&&(t=""),void 0===r&&(r={}),void 0===n&&(n=!1);return!1!==(n=m(n))&&this.trim(n[0],""),this.insert("<"+e+b(r)+(!1!==t?">"+t+"</"+e+">":" />")+(!1!==n?n[1]:""),-1,!0)},g.toggle=function(e,t,r,n){void 0===t&&(t=""),void 0===r&&(r={}),void 0===n&&(n=!1);var o=this,i=o.$(),s=i.after,c=i.before,a=i.value,u=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"}(e),p=function(e){return"</("+e+")>"}(e),f=l(u+"$",""),h=l("^"+p,""),d=f.test(c),g=h.test(s);return g&&d?o.replace(h,"",1).replace(f,"",-1):(f=l("^"+u,""),h=l(p+"$",""),d=f.test(a),(g=h.test(a))&&d&&o.insert(a=a.replace(h,"").replace(f,"")),!a&&t&&o.insert(t),!1!==(n=m(n))&&o.trim(n[0],n[1]),o.wrap("<"+e+b(r)+">","</"+e+">"))},g.wrap=function(e,t,r,n){void 0===t&&(t=""),void 0===r&&(r={}),void 0===n&&(n=!1);var o=this,i=o.$();return i.after,i.before,!i.value&&t&&o.insert(t),!1!==(n=m(n))&&o.trim(n[0],n[1]),o.wrap("<"+e+b(r)+">","</"+e+">")};const q=a.protocol,{toggle:v}=g;let k="[\\w:.-]+",$=e=>"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>",w=e=>"</("+e+")>";function x(e){return!1!==e&&(c(e)?e=[e,e]:r(e)||(e=["",""]),s(e[1])||(e[1]=e[0])),e}const y={};y.blocks=function(){let e=this;return e.record(),function(e){let t=/<(?:h([1-6])|p)(\s[^>]*)?>$/,r=/^<\/(?:h[1-6]|p)>/,{after:n,end:o,before:i,start:s,value:c}=e.$(),a=e.state,p=a.source.tab||a.tab||"\t",f=a.defaults||{};if(!c){let t=n.split("\n").shift(),r=i.split("\n").pop();t.trim()||r.trim()?e.select(s-u(r),o+u(t)):e.insert(f.h1[1])}let h=i.split("\n").pop().match(/^(\s+)/),d=h&&h[1]||"";e.match([t,/.*/,r],(function(e,n,o){let i=this,s=+(e[1]||0),c=e[2]||"",a=e[0]?f[e[0].slice(1,-1).split(/\s/)[0]]:["","",{}];!c&&a[2]&&(c=b(a[2])),i.replace(t,"",-1),i.replace(/\n+/g," "),i.replace(r,"",1);let u=a[3]||f.h1[3];!1!==(u=x(u))&&i.trim(u[0],u[1]),s?(++s,s>6?(i.wrap(d+"<"+f.p[0]+(c||b(f.p[2]))+">","</"+f.p[0]+">"),n[0]&&n[0]!==f.h1[1]&&n[0]!==f.h2[1]&&n[0]!==f.h3[1]&&n[0]!==f.h4[1]&&n[0]!==f.h5[1]&&n[0]!==f.h6[1]&&n[0]!==f.p[1]||i.insert(f.p[1])):(i.wrap(d+"<"+f["h"+s][0]+(c||b(f["h"+s][2]))+">","</"+f["h"+s][0]+">"),n[0]&&n[0]!==f.h1[1]&&n[0]!==f.h2[1]&&n[0]!==f.h3[1]&&n[0]!==f.h4[1]&&n[0]!==f.h5[1]&&n[0]!==f.h6[1]&&n[0]!==f.p[1]||i.insert(f["h"+s][1]))):(i.wrap(d+"<"+f.h1[0]+(c||b(f.h1[2]))+">","</"+f.h1[0]+">"),n[0]&&n[0]!==f.h1[1]&&n[0]!==f.h2[1]&&n[0]!==f.h3[1]&&n[0]!==f.h4[1]&&n[0]!==f.h5[1]&&n[0]!==f.h6[1]&&n[0]!==f.p[1]||i.insert(f.h1[1])),i.replace(l("^("+w("h[1-6]|p")+")\\s*("+w(k)+")"),"$1\n"+d.replace(l("^"+p),"")+"$3",1)})),e.replace(l("^\\s*"+$("blockquote|h[1-6]|p(re)?")),""),e.replace(l(w("blockquote|h[1-6]|p(re)?")+"\\s*$"),"")}(e),e.record(),!1},y.bold=function(){let e=this,t=e.state.defaults||{};return e.record(),v.apply(e,t.b),!1},y.code=function(){let e=this;return e.record(),function(e){let t=/<(pre|code)(?:\s[^>]*)?>(?:\s*<code(?:\s[^>]*)?>)?$/,r=/^(?:<\/code>\s*)?<\/(pre|code)>/,{after:n,end:o,before:i,start:s,value:c}=e.$(),a=e.state;a.source.tab||a.tab;let l=e.state.defaults||{};c||n&&"\n"!==n[0]||i&&"\n"!==i.slice(-1)?e.match([t,/[\s\S]*/,r],(function(e,n,o){let i,s=this;s.replace(t,"",-1),s.replace(r,"",1),!n[0]||!/\n/.test(n[0])&&(o[0]&&"\n"!==o[0][0]||e[0]&&"\n"!==e[0].slice(-1))?o[0]?/^(?:<\/code>\s*)?<\/pre>/.test(o[0])?(i=l[""][3],!1!==(i=x(i))&&s.trim(i[0],i[1]),s.insert(p(n[0]))):o[0].slice(0,7)==="</"+l.code[0]+">"&&(i=l.pre[3],!1!==(i=x(i))&&s.trim(i[0],i[1]),s.wrap("<"+l.pre[0]+b(l.pre[2])+"><"+l.code[0]+b(l.code[2])+">","</"+l.code[0]+"></"+l.pre[0]+">")):(i=l.code[3],!1!==(i=x(i))&&s.trim(i[0],i[1]),s.wrap("<"+l.code[0]+b(l.code[2])+">","</"+l.code[0]+">").insert(f(n[0]||l.code[1]))):(!1!==(i=x(l.pre[3]))&&s.trim(i[0],i[1]),l.pre[0]===o[1]?s.insert(p(n[0])):s.wrap("<"+l.pre[0]+b(l.pre[2])+"><"+l.code[0]+b(l.code[2])+">","</"+l.code[0]+"></"+l.pre[0]+">").insert(f(n[0])))})):e.wrap("<"+l.pre[0]+b(l.pre[2])+"><"+l.code[0]+b(l.code[2])+">","</"+l.code[0]+"></"+l.pre[0]+">").insert(f(l.code[1]))}(e),e.record(),!1},y.image=function(e="URL:",t){let r=this,{after:o,before:i,value:s}=r.$(),c=r.state,a=c.source.tab||c.tab||"\t",l=c.defaults||{},u=i.split("\n").pop().match(/^(\s+)/),p=u&&u[1]||"",f=c.source.prompt;return n(f)&&f(e,s&&/^https?:\/\/\S+$/.test(s)?s:t||q+"//").then((e=>{if(!e)return void r.focus();let t=l.img;s&&(t[2].alt=s,r.record());let n=t[3]||!1;!1!==(n=x(n))&&r.trim(n[0],""),t[2].src=e,o&&"\n"!==o[0]||i&&"\n"!==i.slice(-1)?r.insert("<"+t[0]+b(t[2])+">"+(!1!==n?n[1]:""),-1,!0):(n=l.figure[3]||!1,!1!==(n=x(n))&&r.trim(n[0],n[1]),r.insert(""),r.wrap(p+"<"+l.figure[0]+b(l.figure[2])+">\n"+p+a,p+"\n</"+l.figure[0]+">"),r.insert("<"+t[0]+b(t[2])+">\n"+p+a,-1),r.wrap("<"+l.figcaption[0]+b(l.figcaption[2])+">","</"+l.figcaption[0]+">").insert(l.figcaption[1]))})).catch((e=>0)),r.record(),!1},y.italic=function(){let e=this,t=e.state.defaults||{};return e.record(),v.apply(e,t.i),!1},y.link=function(e="URL:",t){let r=this,{before:o,value:i}=r.$(),s=r.state,c=s.defaults||{},a=s.source.prompt;if(n(a)){let n,s,u,f=c.a;(s=l($(f[0])).exec(o))?(u=!0,s=/\shref=(?:"([^"]+)"|'([^']+)'|([^>\/\s]+))/.exec(s[2]),n=p((s[1]||"")+(s[2]||"")+(s[3]||""))):(s=l("^\\s*"+$(f[0])).exec(i))&&(s=/\shref=(?:"([^"]+)"|'([^']+)'|([^>\/\s]+))/.exec(s[2]),n=p((s[1]||"")+(s[2]||"")+(s[3]||""))),a(e,i&&/^https?:\/\/\S+$/.test(i)?i:n||t||q+"//").then((e=>{if(!e)return void r.focus();i&&r.record(),f[2].href=e;let t={};/[.\/?&#]/.test(e[0])||/^(data|javascript|mailto):/.test(e)||-1===e.indexOf("://")||(t.rel="nofollow",t.target="_blank");let n=x(f[3]||!1);!1!==n||i||(n=[" "," "]),u&&v.call(r,f[0]),v.call(r,f[0],f[1],h(t,f[2]),n)})).catch((e=>0))}return r.record(),!1},y.quote=function(){let e=this;return e.record(),function(e){let t=/<(blockquote|q)(?:\s[^>]*)?>\s*$/,r=/^\s*<\/(blockquote|q)>/,{after:n,end:o,before:i,start:s,value:c}=e.$(),a=e.state,u=a.source.tab||a.tab||"\t",p=e.state.defaults||{};c||n&&"\n"!==n[0]||i&&"\n"!==i.slice(-1)?e.match([t,/[\s\S]*/,r],(function(e,n,o){let i,s=this;s.replace(t,"",-1),s.replace(r,"",1),!n[0]||!/\n/.test(n[0])&&(o[0]&&"\n"!==o[0][0]||e[0]&&"\n"!==e[0].slice(-1))?o[0]?p.blockquote[0]===o[1]?(!1!==(i=x(p[""][3]))&&s.trim(i[0],i[1]),s.replace(l("(^|\\n)"+u),"$1")):p.q[0]===o[1]&&(!1!==(i=x(p.blockquote[3]))&&s.trim(i[0],i[1]),s.wrap("<"+p.blockquote[0]+b(p.blockquote[2])+">\n","\n</"+p.blockquote[0]+">").insert(n[0]||p.blockquote[1]),n[0]!==p.blockquote[1]&&n[0]!==p.q[1]&&s.replace(l("(^|\\n)"),"$1"+u)):(!1!==(i=x(p.q[3]))&&s.trim(i[0],i[1]),s.wrap("<"+p.q[0]+b(p.q[2])+">","</"+p.q[0]+">").insert(n[0]||p.q[1]),s.replace(l("(^|\\n)"+u),"$1")):(!1!==(i=x(p.blockquote[3]))&&s.trim(i[0],i[1]),p.blockquote[0]===o[1]?s.replace(l("(^|\\n)"+u),"$1"):(s.wrap("<"+p.blockquote[0]+b(p.blockquote[2])+">\n","\n</"+p.blockquote[0]+">"),s.replace(l("(^|\\n)"),"$1"+u)))})):e.wrap("<"+p.blockquote[0]+b(p.blockquote[2])+">","</"+p.blockquote[0]+">").insert(p.blockquote[1])}(e),e.record(),!1},y.underline=function(){let e=this,t=e.state.defaults||{};return e.record(),v.apply(e,t.u),!1};const S={defaults:{"":["","text goes here…",{},""],a:["a","link text goes here…",{}],area:["area",!1,{}],b:["strong","text goes here…",{}],base:["base",!1,{href:""},"\n"],blockquote:["blockquote","quote goes here…",{},"\n"],br:["br",!1,{},["","\n"]],button:["button","text goes here…",{name:"",type:"submit"}," "],caption:["caption","table caption goes here…",{},"\n"],code:["code","code goes here…",{}," "],col:["col",!1,{},"\n"],em:["em","text goes here…",{}],figcaption:["figcaption","image caption goes here…",{},"\n"],figure:["figure","",{},"\n"],h1:["h1","title goes here…",{},"\n"],h2:["h2","title goes here…",{},"\n"],h3:["h3","title goes here…",{},"\n"],h4:["h4","title goes here…",{},"\n"],h5:["h5","title goes here…",{},"\n"],h6:["h6","title goes here…",{},"\n"],hr:["hr",!1,{},"\n"],i:["em","text goes here…",{}],img:["img",!1,{alt:"",src:""}," "],input:["input",!1,{name:"",type:"text"}," "],li:["li","list item goes here…",{},"\n"],link:["link",!1,{href:""},"\n"],meta:["meta",!1,{},"\n"],ol:["ol","",{},"\n"],option:["option","option goes here…",{},"\n"],p:["p","paragraph goes here…",{},"\n"],param:["param",!1,{name:""},"\n"],pre:["pre","text goes here…",{},"\n"],q:["q","quote goes here…",{}," "],script:["script","code goes here…",{},"\n"],select:["select","",{name:""}," "],source:["source",!1,{src:""},"\n"],strong:["strong","text goes here…",{}],style:["style","code goes here…",{},"\n"],td:["td","data goes here…",{},"\n"],textarea:["textarea","value goes here…",{name:""}," "],th:["th","title goes here…",{},"\n"],tr:["tr","",{},"\n"],track:["track",!1,{},"\n"],u:["u","text goes here…",{}],ul:["ul","",{},"\n"],wbr:["wbr",!1,{},["","\n"]]},source:{type:"HTML"}};e.canKeyDown=function(e,t){let r=t.state,n=r.source.tab||r.tab||"\t",o=r.defaults||{},{key:i,queue:s}=e;if(s.Control){let{after:e,before:r,end:c,start:a,value:p}=t.$(),f=e.split("\n").shift(),h=r.split("\n").pop(),d=h.match(/^(\s+)/),g=d&&d[1]||"";if("Enter"===i){let r=f.match(l(w(k)+"\\s*$","")),i=o[r&&r[1]||"p"]||o.p;return i[3]=["\n"+g,"\n"+(!s.Shift&&e&&l("^\\s*"+w(k)).test(e.split("\n")[1]||"")?g.replace(l("^"+n),""):g)],t.select(s.Shift?a-u(h):c+u(f)),v.apply(t,i),t.record(),!1}}if(s.Alt||s.Control)return!0;if(">"===i){let e,{after:r,before:n,end:i}=t.$(),s=(n.split("\n").pop()+">").match(l($(k)+"$","")),c=o[e=s&&s[1]||""];return!e||(c?!1!==c[1]?(">"===r[0]?t.select(i+1):t.insert(">",-1),t.insert("</"+e+">",1).insert(c[1])):">"===r[0]?t.insert(" /",-1).select(i+3):t.insert(" />",-1):(">"===r[0]?t.select(i+1):t.insert(">",-1),t.insert("</"+e+">",1)),t.record(),!1)}if("Enter"===i){let e,r,{after:i,before:c,value:a}=t.$(),p=i.split("\n").shift(),f=c.split("\n").pop(),h=f.match(/^(\s+)/),d=h&&h[1]||"",g=["li","option","p","td","th"],m=["pre","script","style"];if(e=f.match(l($(k)+"$",""))){let r=o[e[1]];if(r&&!1===r[1])return t.insert("\n"+d,-1).record(),!1}if(s.Shift){let{br:e}=o;return t.insert("<"+e[0]+b(e[2])+">"+(!1===e[1]?"":e[1]+"</"+e[0]+">")+"\n",-1).record(),!1}if(i&&c){for(let i=0,s=u(g);i<s;++i)if(r=g[i],l("^"+w(r),"").test(p)&&(e=f.match(l("^\\s*"+$(r),""))))return e[0]===f?(o[r]&&a&&o[r][1]===a?t.insert("").wrap("\n"+d+n,"\n"+d):v.call(t,r),t.record(),!1):(t.insert("</"+r+">\n"+d+"<"+r+(e[2]||"")+">",-1).insert(o[r]&&o[r][1]||"").record(),!1);for(let e=0,n=u(m);e<n;++e)if(r=m[e],l("^"+w(r),"").test(p)&&l($(r)+"$","").test(f))return t.wrap("\n"+d,"\n"+d).insert(o[r]&&o[r][1]||"").record(),!1;for(let e=1;e<7;++e)if(p.startsWith("</"+o["h"+e][0]+">")&&f.match(l("^\\s*"+$(o["h"+e][0]),"")))return o["h"+e]&&a&&o["h"+e][1]===a?t.insert("").wrap("\n"+d+n,"\n"+d):t.insert("</"+o["h"+e][0]+">\n"+d+"<"+o.p[0]+">",-1).replace(l("^"+w(o["h"+e][0])),"</"+o.p[0]+">",1).insert(o.p[1]),t.record(),!1}}return!0},e.commands=y,e.state=S}));